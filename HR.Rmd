---
title: "HR"
author: "Mike Pheasant"
date: "01/05/2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# install.packages("tidyverse")
# install.packages("corrplot")
# install.packages('plyr')
# install.packages("plotly")

library(tidyverse)
library(corrplot)
library(car)
library(RColorBrewer)
library(plotly)
library(plyr)
library(dplyr)

```

## Data Import

```{r, include=FALSE}
# Derive a location (Brisbane, San Francisco or London) from the employee role:
# * 90% of IT staff in Brisbane (5% in each other location)
# * 90% Dept in San Francisco (5% in each other location)
# * 90% other categories in London (5% in each other location)

location <- function(role) {
  prob=switch(as.character(role),
              IT=c(0.9, 0.05, 0.05),
              sales=c(0.05, 0.9, 0.05),
              c(0.05, 0.05, 0.9)
  )
  sample(c('Brisbane','San Francisco','London'), 1, rep=TRUE, prob=prob)
}
```

Load raw data (from https://www.kaggle.com/ludobenistant/hr-analytics), add factors, save.

```{r}
HR <- read_csv("HR_comma_sep.csv", col_types=cols(
  satisfaction_level = col_double(),
  last_evaluation = col_double(),
  number_project = col_integer(),
  average_montly_hours = col_integer(),
  time_spend_company = col_integer(),
  Work_accident = col_integer(),
  left = col_integer(),
  promotion_last_5years = col_integer(),
  sales = col_character(),
  salary = col_character()
))
HR <- plyr::rename(HR, replace=c("satisfaction_level"="Satis", "last_evaluation"="Eval",
            "number_project"="NumProj", "average_montly_hours"="MonHrs",
            "time_spend_company"="Tenure", "Work_accident"="Accdt01", 
            "left"="Left01", "promotion_last_5years"="Promo5yr01",
            "sales"="Dept", "salary"="Salary"))

HR$Salary <- factor(HR$Salary, levels=c("low", "medium", "high"), ordered=TRUE)
HR$Dept <- factor(HR$Dept)
# HR$location <- factor(sapply(HR$Dept, location))

HR$Accdt <- factor(HR$Accdt01 == 1)
HR$Promo5yr <- factor(HR$Promo5yr01 == 1)
HR$Left <- factor(HR$Left01==1)

# write_csv(HR, "HR.csv")
```

## Data Summary

### Dimensional Summary

```{r}
summary(HR)
```

### Pairwise Scatter Plots and Distributions for Staying vs Leaving Staff 

```{r eval=FALSE}
plot.new()
png(filename="hr-scatter.png", res=300, width = 3000, height = 3000)
my_colors <- brewer.pal(3, "Set2")
samp.sz <- 3000
pct <- round(100*samp.sz/nrow(HR))
data <- HR[sample(nrow(HR), samp.sz),]
scatterplotMatrix(~Satis+Eval+NumProj+MonHrs+Tenure+Accdt01+Promo5yr01+Dept+Salary|Left01, data=data, reg.line="", smoother="", col=my_colors , smoother.args=list(col="grey") , pch=c(3,4), legend.plot=FALSE, main=paste("Scatter Plot Pairs for HR Turnover (",pct,"% of data)", sep=""))
par(xpd=TRUE, cex=0.7)
legend(x=0.92, y=1.16, c("Stay", "Leave"), col=my_colors, pch=c(3,4), horiz=TRUE)
dev.off()
```

![](hr-scatter.png)

### Pairwise Numeric Correlations within Full Dataset

Leaving is negatively correlated with:

* satisfaction level (-0.39) 
* having a work accident (-0.15) 
* and less so with a promotion in the last 5 years (-0.06)

Leaving is positively correlated with:

* tenure (0.14)
* and less so with average hours worked per month (0.07)

In addition:

* satisfaction level is correlated with last evaluation (0.11), and negatively with number of projects (-0.14) and tenure (-0.10)
* last evaluation is positively correlated with number of projects (0.35), average monthly hours (0.34) and tenure (0.13)

```{r}
M <- cor(HR[1:8])
corrplot(M, method = 'pie', order ="hclust",
         tl.col="black", tl.cex = 1, tl.offset = 0.1, tl.srt = 45, addrect=2)
```

### Pairwise Numeric Correlations for Leaving Employees

```{r}
M <- cor(HR[HR$Left==TRUE,c(1:6,8)])
corrplot(M, method = 'pie', order ="hclust",
         tl.col="black", tl.cex = 1, tl.offset = 0.1, tl.srt = 45, addrect=2)
```


### Pairwise Numeric Correlations for Staying Employees

```{r}
M <- cor(HR[HR$Left==FALSE,c(1:6,8)])
corrplot(M, method = 'pie', order ="hclust",
         tl.col="black", tl.cex = 1, tl.offset = 0.1, tl.srt = 45, addrect=2)
```



## Exploratory Data Analysis

### Career advancement

Many people leaving have been with the company at least 4 years but have not had a promotion in the last 5 years, despite working long hours.

```{r}
with(HR, coplot(MonHrs ~ jitter(Tenure) |
                Promo5yr + Left))
```

These unpromoted, long-term workers who leave are receiving the highest evaluations.

```{r}
with(HR, coplot(Eval ~ jitter(Tenure) |
                Promo5yr + Left))
```

These unpromoted, long-term workers who leave are also reporting high levels of satisfaction with the company.

```{r}
with(HR, coplot(Satis ~ jitter(Tenure) |
                Promo5yr + Left))
```

Of the unpromoted workers putting in long hours who are leaving, some report the lowest levels of satisfaction, but more report very high levels of satisfaction. 

The ones who are working the fewest hours report fairly low satisfaction. 

```{r}
with(HR, coplot(MonHrs ~ Satis |
                Promo5yr + Left))
```

The staff on the largest number of projects and who put in the longest hours, with no promotion in 5 years, tend to leave.

```{r}
with(HR, coplot(MonHrs ~ jitter(NumProj) |
                Promo5yr + Left))
```

Of the unpromoted workers who left, many had both high evaluations and high levels of satisfaction.

```{r}
with(HR, coplot(Eval ~ Satis |
                Promo5yr + Left))
```

## 

Plot:
evaluation, satisfaction | hours + Left
evaluation, satisfaction | time with co + Left
evaluation, satisfaction | NumProj + Left
